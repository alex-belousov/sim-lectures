\input{../common/config}
\title{Hardware Assisted Virtualization}

\begin{document}

\startslides

\begin{frame}{On the Previous Lecture:}
\begin{itemize}
\item \textbf{Simulation}\pause --- replication of system's behavior that can
  be observed through \textbf{\textit{external}} interaction with the system.
\item \textbf{Emulation}\pause --- replication of a system's behavior
  considering how the system \textbf{\textit{internally}} works through
  imitation of all internal structures and processes.
\item \textbf{Virtualization}\pause --- effective isolation of several systems
  from each other with simultaneous and transparent access to resources of the
  underlying system.
\end{itemize}
\end{frame}

\begin{frame}{Simulation vs. Virtualization}
\centering
\inputpicture{simulation-levels}
\vfill
\inputpicture{multiplexing}
\end{frame}

\begin{frame}{History}
\begin{itemize}
\item IBM VM --- 1960.
\item VMware Workstation --- 1998.
\item Intel\reg~VT-x --- 2005.
\end{itemize}
\end{frame}

\section{Formal Requirements}

\subsection{Virtual Machine Concept}

\begin{frame}{Definition}
Gerald J. Popek and Robert P. Goldberg, ``Formal requirements for
virtualizable third generation architectures''~\cite{goldberg}:
\vfill\pause
A \textit{virtual machine} is taken to be an \textbf{efficient},
\textbf{isolated} \textbf{duplicate} of the real machine.
\vfill\pause
\textit{Virtual machine monitor (VMM)} provides:
\begin{enumerate}
\item an environment for programs equivalent to the original machine;\pause
\item programs run in this environment show at worst only minor decreases in
  speed;\pause
\item the VMM is in complete control of system resources.
\end{enumerate}
\end{frame}

\begin{frame}{Properties}
\begin{itemize}
\item \textbf{Equivalent} means that any program runnig under the
  VMM control should demonstrated identical to the original machine behavoir,
  except differencies caused by the availability of system resources and
  timing.\pause
\item \textbf{Efficiency} demands that a statistically dominant subset of the
  virtual processor's instructions is executed directly by the real processor,
  with no software intervention by the VMM.\pause
\item \textbf{Resource control}:
  \begin{enumerate}
  \item a program running under VMM cannot access resources not explicitly
    allocated to it;
  \item VMM can regain control of already allocated resources.
  \end{enumerate}
\end{itemize}
\end{frame}

\subsection{Model of Machines}

\begin{frame}{Model of Machines}
\begin{itemize}
\item Single processor executing instructions.
\item The processor's state $(E, M, P, R)$:
  \begin{itemize}
  \item Linear memory $E$ of size $q$, addressing $E[i]$,
  \item Two modes $M$: $u$ (user) and $s$ (supervisor),
  \item Program counter --- $P$,
  \item Memory segment --- $R (l, b)$.
  \end{itemize}
\item Instruction $i(E_1, M_1, P_1, R_1) = (E_2, M_2, P_2, R_2)$.
\end{itemize}
\end{frame}

\begin{frame}{Trap}
An instruction $i$ is trap if:
\begin{equation*}
  \begin{aligned}
  i(E_1, M_1, P_1, R_1) &= (E_2, M_2, P_2, R_2)\text{, where} \\
  E_2[j] &= E_1[j]\text{, for} 0 < j < q, \\
  E_2[0] &= (M_1, P_1, R_1), \\
  (M_2, P_2, R_2) &= E_1[1].
  \end{aligned}
\end{equation*}
\pause\vfill
Trap types:
\begin{enumerate}
\item Control trap --- caused by an attempt to change the processor's state.
\item Memory trap --- caused by an attampt to access an out of bound address.
\end{enumerate}
\end{frame}

\begin{frame}{Instructions}
\begin{itemize}
\item \textbf{Prigileged}: execution with $M=u$ always causes a
  control trap.\pause
\item \textbf{Sensitive}:
  \begin{itemize}
  \item \textit{Control} sensitive instructions change $M$ and/or $R$.
  \item \textit{Behavior} sensitive instructions operates differently depending
    on $M$ or $R$.\pause
  \end{itemize}
  \item \textbf{Innocuous} --- neither privileged nor sensitive.
\end{itemize}
\end{frame}

\subsection{Sufficient Conditions for Virtualizability}

\begin{frame}{Sufficient Conditions for Virtualizability}
A virtual machine monitor may be constructed if the set of sensitive instructions for that computer is a subset of the set of privileged instructions.
\vfill\centering
\inputpicture{vm-sufficient-condition} 
\end{frame}

\begin{frame}{Construction}
\begin{enumerate}
\item VMM operates in supervisor mode.
\item VMs operate in user mode:
  \begin{itemize}
  \item innocuous instructions are executed directly,
  \item sensitive instructions cause traps and emulation by VMM,
  \item privileged instructions case traps and emulation by VMM.
  \end{itemize}
\end{enumerate}
\pause
\centering$\Downarrow$
\begin{enumerate}
  \item Isolation,
  \item Equivalence,
  \item Efficiency.
\end{enumerate}
\end{frame}

\begin{frame}{Trap and Emulate}
\centering
\inputpicture{trap-and-emulate}
\end{frame}

\section{Types of Hypervisors}

% TODO: Place the next two frame on one slide with vertical split
\begin{frame}{Types of Hypervisors}
Type 1 --- bare-metal hypervisor:
\vfill
\centering
\inputpicture{vm-type1}
\vfill
\begin{itemize}
\item Microsoft Hyper-V,
\item Linux KVM,
\item VMware ESXi,
\end{itemize}
\end{frame}

\begin{frame}{Types of Hypervisors}
Type 2 --- hosted hypervisor:
\vfill
\centering
\inputpicture{vm-type2}
\vfill
\begin{itemize}
\item Oracle VirtualBox,
\item VMware Workstation/Fusion,
\item Parallels Desktop,
\end{itemize}
\end{frame}

\section{Современные корректировки}

\begin{frame}{Что не упомянуто в условии Г. и П.}

\begin{itemize}
    \item Сложные схемы трансляции адресов
    \item Периферия
    \item Многопроцессорные системы
\end{itemize}
\end{frame}

\subsection{Трансляция адресов}

\begin{frame}[shrink=20]{Трансляция адресов}
\centering
\inputpicture{two-level-translation} 
\end{frame}

\begin{frame}{Виртуализация TLB}
\begin{center}
\begin{tabular}{rrr}
Виртуальный адрес & Физический адрес & Тэг\\
0x11112222000 &  0x22220000 & VM1\\
0x11112222000 &  0x11110000 & VM2\\
0x44443333000 &  0x55554000 & MON\\
0xabcd9876000 &  0x00001000 & VM1\\
0xabcd9876000 &  0x11111000 & VM3
 \end{tabular}
\end{center}
\end{frame}

\subsection{Периферийные устройства}

\begin{frame}{Периферийные устройства}
\begin{itemize}
    \item Кому доставлять прерывание?
    \item Что делать, если прерывания внутри ВМ запрещены?
\end{itemize}

\vfill
\centering
\begin{tikzpicture}[>=latex, font=\small, align=center]
    \node[draw] (dev) {Устройство};

    \node[draw, rounded corners, right=2cm of dev, text width=2.2cm] (vmm) {Монитор ВМ};
    \node[draw, rounded corners, below = 0.5 cm of vmm, text width=2.2cm] (vm1) {ВМ 1};
    \node[draw, rounded corners, below = 0.5cm of vm1, text width=2.2cm] (vm2) {ВМ 2};

    \node[draw, left=0.5cm of vm1, cloud] (sel) {?};

    \draw[->] (dev) |- (sel);
    \draw[->] (sel) -- (vmm);
    \draw[->] (sel) -- (vm1);
    \draw[->] (sel) -- (vm2);
\end{tikzpicture}

\end{frame}

\begin{frame}{Консервативный подход}
\begin{itemize}
    \item Все прерывания доставляются монитору
    \item Монитор «впрыскивает» их в ВМ
    \item Повышенная задержка доставки прерываний
\end{itemize}

\vfill
\centering
\begin{tikzpicture}[>=latex, font=\small, align=center]
    \node[draw] (dev) {Устройство};

    \node[draw, rounded corners, right=2cm of dev, text width=2.2cm] (vmm) {Монитор ВМ};
    \node[draw, rounded corners, below = 0.5 cm of vmm, text width=2.2cm] (vm1) {ВМ 1};
    \node[draw, rounded corners, below = 0.5cm of vm1, text width=2.2cm] (vm2) {ВМ 2};

    \draw[->] (dev) -- (vmm);
    \draw[->] (vmm) -- (vm1);
\end{tikzpicture}

\end{frame}

\begin{frame}{Аппаратная поддержка}
Аппаратура обеспечивает доставку выбранных прерываний в текущую ВМ, остальные — в монитор

\vfill
\centering
\begin{tikzpicture}[>=latex, font=\small, align=center]
    \node[draw] (dev) {Устройство};

    \node[draw, rounded corners, right=2.5cm of dev, text width=2.2cm] (vmm) {Монитор ВМ};
    \node[draw, rounded corners, below = 0.5 cm of vmm, text width=2.2cm] (vm1) {ВМ 1};
    \node[draw, rounded corners, below = 0.5cm of vm1, text width=2.2cm] (vm2) {В М 2};

    \node[draw, left=1.5cm of vm1, trapezium, shape border rotate=270] (sel) {HW};

    \draw[->] (dev) |- (sel);
    \draw[->] (sel) -- (vmm.west) node[above, midway, font=\tiny, xshift=-0.25cm] {Остальные\\прерывания};
    \draw[->] (sel) -- (vm1) node[below, midway, font=\tiny ] {Разрешённые\\прерывания};
\end{tikzpicture}

\end{frame}

\subsection{Многопроцессорность}

\begin{frame}{Многопроцессорность}
\begin{itemize}
    \item Планировка исполнения $N$ виртуальных процессоров на $M$ физических, $N \geqslant M$
    \begin{itemize}
        \item Справедливая (fair)
        \item Эффективная — характерные длительности синхронизационных процессов внутри ВМ должны быть близки к наблюдаемым на реальной аппаратуре
    \end{itemize}
\end{itemize}

\begin{itemize}
    \item Проблема вытеснения потоков, заблокировавших ресурсы (lock holder preemption)
    \item Монитору необходимо детектировать новый класс гостевых инструкций — синхронизационные примитивы (атомарные инструкции)
\end{itemize}

\end{frame}

\begin{frame}[allowframebreaks]{Bibliography}
\begin{thebibliography}{99}
\bibitem{goldberg} Popek Gerald J., Goldberg Robert P. Formal requirements for virtualizable third generation architectures // Communications of the ACM. V. 17. \#7. 1974.
\bibitem{vtx} Leung, F. [et al.] Intel® Virtualization Technology // ITJ Vol 10 Issue 3 — 2006.
\bibitem{mpr} Harlan McGhan. The gHost in the Machine: Parts 1,2,3 // Microprocessor Report. 2007. \url{http://mpronline.com}
\bibitem{virt-locks} Jiannan Ouyang and John R. Lange. Preemptable ticket spinlocks: improving consolidated performance in the cloud — 2013 \url{https://labs.vmware.com/vee2013/docs/p191.pdf}
\bibitem{my-virt} Аппаратная виртуализация. Теория, реальность и поддержка в архитектурах процессоров \url{http://habrahabr.ru/company/intel/blog/196444/}
\end{thebibliography}
\end{frame}

\begin{frame}{На следующей лекции}
\centering

Паравиртуализация

\end{frame}

\finalslide

\end{document}
